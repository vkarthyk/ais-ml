<stix:STIX_Package xmlns:stix="http://stix.mitre.org/stix-1" xmlns:AIS="http://www.us-cert.gov/STIXMarkingStructure#AISConsentMarking-2" xmlns:CISCP="http://us-cert.gov/ciscp" xmlns:FileObj="http://cybox.mitre.org/objects#FileObject-2" xmlns:MutexObj="http://cybox.mitre.org/objects#MutexObject-2" xmlns:cybox="http://cybox.mitre.org/cybox-2" xmlns:cyboxCommon="http://cybox.mitre.org/common-2" xmlns:cyboxVocabs="http://cybox.mitre.org/default_vocabularies-2" xmlns:indicator="http://stix.mitre.org/Indicator-2" xmlns:marking="http://data-marking.mitre.org/Marking-1" xmlns:simpleMarking="http://data-marking.mitre.org/extensions/MarkingStructure#Simple-1" xmlns:stix-ciq="http://stix.mitre.org/extensions/Identity#CIQIdentity3.0-1" xmlns:stixCommon="http://stix.mitre.org/common-1" xmlns:stixVocabs="http://stix.mitre.org/default_vocabularies-1" xmlns:tlpMarking="http://data-marking.mitre.org/extensions/MarkingStructure#TLP-1" xmlns:xal="urn:oasis:names:tc:ciq:xal:3" xmlns:xnl="urn:oasis:names:tc:ciq:xnl:3" xmlns:xpil="urn:oasis:names:tc:ciq:xpil:3" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="CISCP:IB-15-10134" timestamp="2015-04-09T18:10:16Z" version="1.1.1" xsi:schemaLocation="http://cybox.mitre.org/objects#DomainNameObject-1 http://cybox.mitre.org/XMLSchema/objects/Domain_Name/1.0/Domain_Name_Object.xsd   http://cybox.mitre.org/objects#PortObject-2 http://cybox.mitre.org/XMLSchema/objects/Port/2.1/Port_Object.xsd   http://cybox.mitre.org/common-2 http://cybox.mitre.org/XMLSchema/common/2.1/cybox_common.xsd   http://cybox.mitre.org/objects#WinRegistryKeyObject-2 http://cybox.mitre.org/XMLSchema/objects/Win_Registry_Key/2.1/Win_Registry_Key_Object.xsd   http://stix.mitre.org/default_vocabularies-1 http://stix.mitre.org/XMLSchema/default_vocabularies/1.1.1/stix_default_vocabularies.xsd   http://cybox.mitre.org/objects#FileObject-2 http://cybox.mitre.org/XMLSchema/objects/File/2.1/File_Object.xsd   http://data-marking.mitre.org/Marking-1 http://stix.mitre.org/XMLSchema/data_marking/1.1.1/data_marking.xsd   http://cybox.mitre.org/objects#SocketAddressObject-1 http://cybox.mitre.org/XMLSchema/objects/Socket_Address/1.1/Socket_Address_Object.xsd   http://stix.mitre.org/common-1 http://stix.mitre.org/XMLSchema/common/1.1.1/stix_common.xsd   http://data-marking.mitre.org/extensions/MarkingStructure#TLP-1 http://stix.mitre.org/XMLSchema/extensions/marking/tlp/1.1.1/tlp_marking.xsd   http://stix.mitre.org/stix-1 http://stix.mitre.org/XMLSchema/core/1.1.1/stix_core.xsd   http://cybox.mitre.org/objects#LinkObject-1 http://cybox.mitre.org/XMLSchema/objects/Link/1.1/Link_Object.xsd   http://cybox.mitre.org/objects#AddressObject-2 http://cybox.mitre.org/XMLSchema/objects/Address/2.1/Address_Object.xsd   http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd   http://cybox.mitre.org/objects#URIObject-2 http://cybox.mitre.org/XMLSchema/objects/URI/2.1/URI_Object.xsd   http://stix.mitre.org/Indicator-2 http://stix.mitre.org/XMLSchema/indicator/2.1.1/indicator.xsd   http://cybox.mitre.org/objects#EmailMessageObject-2 http://cybox.mitre.org/XMLSchema/objects/Email_Message/2.1/Email_Message_Object.xsd   http://data-marking.mitre.org/extensions/MarkingStructure#Simple-1 http://stix.mitre.org/XMLSchema/extensions/marking/simple/1.1.1/simple_marking.xsd   http://cybox.mitre.org/objects#MutexObject-2 http://cybox.mitre.org/XMLSchema/objects/Mutex/2.1/Mutex_Object.xsd   http://cybox.mitre.org/objects#NetworkConnectionObject-2 http://cybox.mitre.org/XMLSchema/objects/Network_Connection/2.1/Network_Connection_Object.xsd      http://cybox.mitre.org/objects#HTTPSessionObject-2 http://cybox.mitre.org/XMLSchema/objects/HTTP_Session/2.1/HTTP_Session_Object.xsd   http://cybox.mitre.org/cybox-2 http://cybox.mitre.org/XMLSchema/core/2.1/cybox_core.xsd     http://www.us-cert.gov/STIXMarkingStructure#AISConsentMarking-2 http://www.us-cert.gov/sites/default/files/STIX_Namespace/AIS_Bundle_Marking_1.1.1_v1.0.xsd     http://stix.mitre.org/extensions/Identity#CIQIdentity3.0-1 http://stix.mitre.org/XMLSchema/extensions/identity/ciq_3.0/1.1.1/ciq_3.0_identity.xsd     urn:oasis:names:tc:ciq:xpil:3 http://stix.mitre.org/XMLSchema/external/oasis_ciq_3.0/xPIL.xsd"><stix:STIX_Header><stix:Title>CTFMONv4 Variant X Malware and Signatures</stix:Title><stix:Package_Intent xsi:type="stixVocabs:PackageIntentVocab-1.0">Indicators - Malware Artifacts</stix:Package_Intent><stix:Description>On 25 March 2015, a malware sample of CTFMONv4 Variant X was analyzed by a US Government Department. Signatures were developed based on the subdirectory naming algorithm used in communications with the command and control (C2) sites.

Note that the naming convention of Variant X was assigned for analysis purposes. The malware itself does not self-identify its variants.</stix:Description><stix:Handling><marking:Marking><marking:Controlled_Structure>//node() | //@*</marking:Controlled_Structure><marking:Marking_Structure xsi:type="AIS:AISMarkingStructure"><AIS:Not_Proprietary CISA_Proprietary="false"><AIS:AISConsent consent="EVERYONE"/><AIS:TLPMarking color="AMBER"/></AIS:Not_Proprietary></marking:Marking_Structure><marking:Information_Source><stixCommon:Identity xsi:type="stix-ciq:CIQIdentity3.0InstanceType"><stix-ciq:Specification><xpil:PartyName><xnl:OrganisationName><xnl:NameElement>NCCIC</xnl:NameElement></xnl:OrganisationName></xpil:PartyName><xpil:Addresses><xpil:Address><xal:Country><xal:NameElement xal:NameCode="US" xal:NameCodeType="ISO 3166-1 alpha-2"/></xal:Country><xal:AdministrativeArea><xal:NameElement xal:NameCode="US-DC" xal:NameCodeType="ISO 3166-2"/></xal:AdministrativeArea></xpil:Address></xpil:Addresses><xpil:OrganisationInfo xpil:IndustryType="Information Technology Sector"/></stix-ciq:Specification></stixCommon:Identity></marking:Information_Source></marking:Marking></stix:Handling><stix:Information_Source><stixCommon:Time><cyboxCommon:Produced_Time>2015-04-09T18:10:16Z</cyboxCommon:Produced_Time></stixCommon:Time></stix:Information_Source></stix:STIX_Header><stix:Indicators><stix:Indicator id="CISCP:indicator-96f801a4-b7fa-4fb8-a426-009072974493" version="2.1.1" xsi:type="indicator:IndicatorType"><indicator:Type xsi:type="stixVocabs:IndicatorTypeVocab-1.1">Malware Artifacts</indicator:Type><indicator:Description>File Import Hash: 89449F41FB814A43BEB60D0997508770
PE Compile time: 2015-02-05 13:54:30
File type: 32 bit DLL (export: "DllTest_2")

This is a CTFMONv4 Variant X malware sample. All known versions of CTFMON use HTTP GET requests and server responses for command and control (C2) over TCP port 80. The format of the CTFMONv4 Variant X HTTP GET requests varies significantly from other versions, as there are two beacons with Variant X, and the second beacon has a unique structure.

CTFMONv4 Variant X differs from Variants A, B, and C most significantly in its C2 communications. The initial request "GET /&lt;xxxxx&gt;.html" contains a variable number that falls into the a range between 11111 to 43878. This communication is new in Variant X.

Variant X also differs from Variants A, B, and C in that the second GET request's initial sub-directory is no longer a legible word, but rather a string of characters generated through an algorithm new to variant X. The initial GET request's sub-directory will always be four or six characters in length and will be comprised only of letters from the lowercase alphabet (a-z). These 4 or 6 characters are initially selected variably, then the second-to-last character is modified according to an algorithm:

(0xD9 or 0xDA or 0xDB)* - (first character in string)** == (2nd-to-last character in string)
*One of these three static values is selected randomly.
** Selected randomly from the first 24 characters of the lowercase English alphabet (a-x).

Given this algorithm, the following table can be built to predict the second-to-last character:
If the first randomly selected character is a-z, then the 2nd-to-last character will be one of these three values:

a: x y z
b: w x y
c: v w x
d: u v w
e: t u v
f: s t u
g: r s t
h: q r s
i: p q r
j: o p q
k: n o p
l: m n o
m: l m n
n: k l m
o: j k l
p: i j k
q: h i j
r: g h i
s: f g h
t: e f g
u: d e f
v: c d e
w: b c d
x: a b c

The remainder of the GET string contains well-obfuscated victim information buffered with a random-length random string, which could defeat network signatures.

The following Snort rule can potentially identify valid Variant X traffic based on the unique relationship between characters in the initial sub-directory as described above. Due to the variation in the communication structure, the content match must be as loosely defined as possible to allow the Perl Compatible Regular Expression (PCRE) to execute and complete the more thorough check of the packet. The signature is designed to detect instances when the first character is 'a'. A total of 23 modified versions of this signature should be deployed to detect the other possible initial characters. As a consequence of this matching, a large number of false-positives is possible.

Example Snort rule to detect instances when the first character of the beacon is 'a':

alert tcp any any &lt;&gt; any [80] (msg:"IMPLANT_BEACON";content:"GET /a"; pcre:"/\/a[a-z]{1,3}[xyz][a-z]\//"; sid:1;)

The following is a Yara signature designed to detect CTFMON V4 Variant X, specifically the portions that build the 4 or 6 character sub-directory described by the algorithm presented earlier:
rule

implant_varx_beacon_sub_dir_builder {
strings:
$BuildAlphabetString = {8A C8 80 C1 61 88 4C 04 14 40 83 F8 1A 7C F1}
$BuildRando = {33 D2 F7 F3 46 8A 54 14 1C 88 54 37 FF 3B F5 72}
$SetupConstants = {3C 78 5E C7 44 24 08 D9 00 00 00 C7 44 24 0C DA 00
00 00 C7 44 24 10 DB 00 00 00 C7 44 24 14 00 00 00 00 5B}
$Modify2ndToLastChar = {B9 03 00 00 00 F7 F9 8B 4C 24 54 8B C5 8A 54 94 04 2A 17
C6 04 2F 00 88 54 2F FE}
condition:
all of them
}</indicator:Description><indicator:Observable id="CISCP:Observable-f4bbf786-3ac6-49c7-9b82-0257046bdfcd"><cybox:Object id="CISCP:Object-553ea83c-c2ac-4188-9512-97c43c46b717"><cybox:Properties xsi:type="FileObj:FileObjectType"><FileObj:Size_In_Bytes condition="Equals">149504</FileObj:Size_In_Bytes><FileObj:Hashes><cyboxCommon:Hash><cyboxCommon:Type condition="Equals" xsi:type="cyboxVocabs:HashNameVocab-1.0">MD5</cyboxCommon:Type><cyboxCommon:Simple_Hash_Value condition="Equals">b42cc82eee434ffe786daade5fd91880</cyboxCommon:Simple_Hash_Value></cyboxCommon:Hash></FileObj:Hashes></cybox:Properties><cybox:Related_Objects><cybox:Related_Object id="CISCP:Object-cb185a7a-ce73-45e1-8ab5-5e8a369bc19b"><cybox:Properties xsi:type="MutexObj:MutexObjectType"><MutexObj:Name condition="Equals">MutexTest_IeInBrowser</MutexObj:Name></cybox:Properties><cybox:Relationship xsi:type="cyboxVocabs:ObjectRelationshipVocab-1.1">Created</cybox:Relationship></cybox:Related_Object></cybox:Related_Objects></cybox:Object></indicator:Observable><indicator:Kill_Chain_Phases><stixCommon:Kill_Chain_Phase kill_chain_id="stix:KillChain-af3e707f-2fb9-49e5-8c37-14026ca0a5ff" kill_chain_name="LM Cyber Kill Chain" name="Installation" ordinality="5" phase_id="stix:KillChainPhase-e1e4e3f7-be3b-4b39-b80a-a593cfd99a4f"/></indicator:Kill_Chain_Phases><indicator:Sightings sightings_count="1"><indicator:Sighting timestamp="2015-03-25T00:00:00"/></indicator:Sightings></stix:Indicator></stix:Indicators><stix:TTPs><stix:Kill_Chains><stixCommon:Kill_Chain definer="LMCO" id="stix:KillChain-af3e707f-2fb9-49e5-8c37-14026ca0a5ff" name="LM Cyber Kill Chain" number_of_phases="7" reference="http://www.lockheedmartin.com/content/dam/lockheed/data/corporate/documents/LM-White-Paper-Intel-Driven-Defense.pdf"><stixCommon:Kill_Chain_Phase name="Reconnaissance" ordinality="1" phase_id="stix:KillChainPhase-af1016d6-a744-4ed7-ac91-00fe2272185a"/><stixCommon:Kill_Chain_Phase name="Weaponization" ordinality="2" phase_id="stix:KillChainPhase-445b4827-3cca-42bd-8421-f2e947133c16"/><stixCommon:Kill_Chain_Phase name="Delivery" ordinality="3" phase_id="stix:KillChainPhase-79a0e041-9d5f-49bb-ada4-8322622b162d"/><stixCommon:Kill_Chain_Phase name="Exploitation" ordinality="4" phase_id="stix:KillChainPhase-f706e4e7-53d8-44ef-967f-81535c9db7d0"/><stixCommon:Kill_Chain_Phase name="Installation" ordinality="5" phase_id="stix:KillChainPhase-e1e4e3f7-be3b-4b39-b80a-a593cfd99a4f"/><stixCommon:Kill_Chain_Phase name="Command and Control" ordinality="6" phase_id="stix:KillChainPhase-d6dc32b9-2538-4951-8733-3cb9ef1daae2"/><stixCommon:Kill_Chain_Phase name="Actions on Objectives" ordinality="7" phase_id="stix:KillChainPhase-786ca8f9-2d9a-4213-b38e-399af4a2e5d6"/></stixCommon:Kill_Chain></stix:Kill_Chains></stix:TTPs></stix:STIX_Package>